stage('Safety Check') {
    steps {
        script {
            def safetyCommand = "safety check -r requirements.txt"
            
            def safetyOutput = sh(script: safetyCommand, returnStdout: true).trim()
            
            // Filter out beta version fixes
            def nonBetaVulnerabilities = sh(script: """
                echo '${safetyOutput}' | grep -v -E '\\bb[0-9]*\\b'
            """, returnStdout: true).trim()
            
            def vulnerabilityCount = sh(script: """
                echo '${nonBetaVulnerabilities}' | grep -c '^\\[\\!'
            """, returnStdout: true).trim() as Integer
            
            if (vulnerabilityCount > 0) {
                error "Safety check failed due to ${vulnerabilityCount} non-beta vulnerabilities"
            } else {
                echo "Safety check passed (ignoring beta version fixes)"
            }
            
            echo "Full safety check output:\n${safetyOutput}"
        }
    }
}
